<?php
    if($target_url == 'insert'){
        $page_title = L('发布') . $event_type_label;
    }else{
        $page_title = L('编辑') . $event_type_label;
    }
?>
{:W('Header',array('title'=>$page_title))}
<script type="text/javascript" src="{:C('MAP_APICONNECTSTR')}">
</script>

<form id="newform" name="newform" class="need-validate" action="__URL__/{$target_url}" method="post" >
<div id="main">
    <h2 class="title"><?php echo $page_title; ?></h2>
      <input type="hidden" name="type" value="{$event_type}"/>
      <?php if($target_url != 'insert' && $_SESSION['login_user']['is_admin']):  ?>
      <label>{:L('创建人')}</label>
      <div id="creator" class="form-field">
          <input id="creator-field" name="creator" validate-url="{:U('User/check_exist')}" class="optional ajax-validate text-box long-text" type="text" value="{$event.creator_name}"/>
      </div>
      <?php endif; ?>
      <?php if (isset($event)): ?>
      <input type="hidden" name="id" value="{$event.id}"/>
      <?php endif; ?>
    <label>{$field_title.event_name}</label>
    <div class="form-field">
        <input type="text" id="name" name="name" class="required long-text" value="{$event.name}"/>
        <p>{:L('100个汉字以内')}</p>
    </div>
    <label>{:L('相关机构')}</label>
    <div class="form-field">
    	<input type="text" class="long-text" id="host-field" name="host" value="{$event.host}"/><p>{:L('多个主办方用英文逗号分隔')}</p>
    </div>
    <?php if($event_type != 'ind' && $event_type != 'case'): ?>
    <label>{:L('开始时间')}</label>
    <div class="form-field">
        <input type="text" name="begin_time" id="range-from" value="{$event.begin_time}"/>
        <img src="__APP__/Public/Img/calendar.png" class="calendar"/>
    </div>
    <label>{:L('结束时间')}</label>
    <div class="form-field">
        <input type="text" name="end_time" id="range-to" value="{$event.end_time}"/>
        <img src="__APP__/Public/Img/calendar.png" class="calendar"/>
    </div>
    <?php endif; ?>
    <div>
        {:W('MapLocate', array('longitude' => $event['longitude'], 'latitude' => $event['latitude'], 'place' => $event['place'], 'place_label' => $field_title['place']))}
    </div>
    <label>{$field_title.introduction}</label>
    <div class="form-field">
        <textarea name="description" id="description" class="required" cols="80" rows="15">{$event.description}</textarea>
    </div>
    <?php if($event_type != 'ind' && $event_type != 'case'): ?>
    <label>{:L('项目成果')}</label>
    <div class="form-field">
        <textarea name="outcome" id="outcome" class="required" cols="80" rows="10">{$event.outcome}</textarea>
        <p>{:L('已经取得的和预期的成果')}</p>
    </div>
    <?php endif; ?>
    <label>{:L('项目领域')}</label>
    <div class="form-field event-field">
        <?php if(isset($event['item_field'])){
                $event_field = explode(' ', $event['item_field']);
              }else{
                $event_field = array();
              }
              if(isset($event['res_tags'])){
                $event_res_tags = explode(' ', $event['res_tags']);
              }else{
                $event_res_tags = array();
              }
        ?>
        <?php
            $i = 0;
            foreach(C('ORG_FIELDS') as $org){
            $i++;
            ?>
        <span class="res-tag">
            <input id="event-field-{$i}" type="checkbox" name="event_field[]" value="{$org}" <?php if (in_array($org, $event_field)): ?> checked="checked" <?php endif; ?>/>
            <label for="event-field-{$i}">{$org}</label>
        </span>
        <?php } ?>
        <p>{:L('根据项目需要选择一或多个项目领域')}</p>
    </div> 
    <?php
    	$config_event_type = C('EVENT_TYPE')
    ?>
    <?php if($event_type != 'ngo'): ?>
    <label>{:L('项目资源')}</label>
    <div class="form-field event-field">
        <?php
            $i = 0;
            foreach($config_event_type['resource'] as $one_type){ 
            $i++;
        ?>
        <span class="res-tag">
            <input id="event-resource-{$i}" type="checkbox" name="event_type[]" value="{$one_type}" <?php if (in_array($one_type, $event_res_tags)||$create_resource_type==$one_type): ?> checked="checked" <?php endif; ?>/>
            <label for="event-resource-{$i}">{$one_type}</label>
        </span>
        <?php } ?>
        <p>{:L('选择项目能够提供给他方的资源。如没有可不选。')}</p>
    </div>
    <?php endif; ?>
    <?php if($event_type != 'ind' && $event_type != 'case'): //对于对接案例和公益报道，不显示需求页 ?>
    <label>{:L('项目需求')}</label>
    <div class="form-field event-field">
         <?php
        	$i = 0;
        	foreach($config_event_type['requirement'] as $one_type){ 
        	$i++;
        ?>
        <span class="res-tag">
            <input id="event-requirement-{$i}" type="checkbox" name="event_type[]" value="{$one_type}" <?php if (in_array($one_type, $event_res_tags)||$create_resource_type==$one_type): ?> checked="checked" <?php endif; ?>/>
            <label for="event-requirement-{$i}">{$one_type}</label>
        </span>
        <?php } ?>
        <p>{:L('选择项目需要他方帮助的需求。如没有可不选。')}</p>
    </div>
    <label>{:L('需求描述')}</label>
    <div class="form-field">
        <textarea name="req_description" id="req_description" class="optional" cols="80" rows="10">{$event.outcome}</textarea>
        <p>{:L('请具体陈述您的需求，这将帮助您获得更有效的支持，如：需要200本小学生课外读物，需要环境保护领域的法律专家等……')}</p>
    </div>
    
    <h3>{:L('联系信息')}</h3>
    <label>{:L('联系人')}</label>
    <div class="form-field">
    	<input type="text" name="contact_name" value="{$event.contact_name}"/>
    	<p>{:L('联系人的姓名')}</p>
    </div>
    <label>{:L('联系电话')}</label>
    <div class="form-field">
    	<input type="text" name="contact_phone" value="{$event.contact_phone}"/>
    	<p>{:L('请填写机构电话')}</p>
    </div>
    <label>{:L('联系电子邮箱')}</label>
    <div class="form-field">
    	<input type="text" class="long-text" name="contact_email" value="{$event.contact_email}"/>
    </div>
    <label>{:L('联系QQ')}</label>
    <div class="form-field">
    	<input type="text" name="contact_qq" value="{$event.contact_qq}"/>
    </div>
    <?php endif; ?>
    <label>{:L('项目标签')}</label>
    <div class="form-field">
        <div id="tag-input">
        	<input type="text" id="tag-name" class="long-text" name="tags" value="{$tags}"/>
        </div>
        <div class="event-field"><p>{:L('可为项目添加若干标签。请使用逗号来分割标签')}</p></div>
    </div>
    <?php if($event_type == 'ind' || $event_type == 'case'): ?>
    <label>{:L('信息来源')}</label>
    <div class="form-field"><input type="text" class="long-text" name="url" value="{$event.url}"/><p>{:L('此条信息的来源网址')}</p></div>
    <?php else: ?>
    <label>{:L('相关网址')}</label>
    <div class="form-field"><input type="text" class="long-text" name="url" value="{$event.url}"/><p>{:L('如项目的网站地址。事件添加后可增加更多的网址')}</p></div>
    <?php endif; ?>
    <div class="form-field">
        <span class="res-tag">
            <input type="checkbox" id="is_commentable" name="is_commentable" value="1" <?php if (!isset($event['is_commentable']) || $event['is_commentable'] != 0): ?> checked="checked" <?php endif; ?>/>
            <label class="inline-block" for="is_commentable">{:L('允许对该事件发表感想')}</label>
        </span>
        <p>{:L('事件添加后，您可以向事件中上传图片、添加视频链接。<br/>事件需要通过审核才能被他人看见。')}</p>
    </div>
    <div class="form-field"><input id="submit-button" type="submit" value="{:L('确认提交')}"/></div>
    </div>
</form>

<script language="javascript">
var validate_require_string = "{:L('(必填)')}";
var validate_require_error_string = "{:L('此项必填')}";
</script>
<css href="__APP__/Public/Css/EventEdit.css"/>
<css href="__APP__/Public/Css/ngo-validate.css"/>
<css href="__APP__/Public/Css/AdminEvents.css"/>
<js href="__APP__/Public/Js/jquery-ui-1.8.9.custom.min.js"/>
<css href="__APP__/Public/Css/start/jquery-ui-1.8.9.custom.css"/>
<js href="__APP__/Public/Js/jquery.ui.datepicker-zh-CN.js"/>
<js href="__APP__/Public/Js/ngo-validate.js"/>
<script language="javascript">
$(document).ready(function(){ 
    //MapLocate组建选择显示'项目地点'及相符信息
   $('.event_locate').show();
   $("#range-from, #range-to" ).datepicker({ dateFormat: 'yy-mm-dd' } , $.datepicker.regional[ "zh-CN" ] );
   $('.calendar').click(function(){
       $(this).siblings().focus();
   });
   
   $('#host-field').autocomplete("{:U('Event/suggest')}",{
	   	multiple: true,
		matchContains: true
   });
   $('#creator-field').autocomplete("{:U('Event/suggest')}",{
	   	multiple: false,
		matchContains: true
   });
   $('#tag-name').autocomplete("{:U('Event/suggest')}/type/tag",{
	   	multiple: true,
		matchContains: true
   });
});
</script>

{:W('Footer')}
