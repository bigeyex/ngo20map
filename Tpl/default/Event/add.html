<?php
    if($target_url == 'insert'){
        $page_title = L('发布') . $event_type_label;
    }else{
        $page_title = L('编辑') . $event_type_label;
    }
?>
{:W('Header',array('title'=>$page_title))}
<script type="text/javascript" src="{:C('MAP_APICONNECTSTR')}">
</script>

<div id="main" class="form-region">
    <form id="newform" name="newform" class="need-validate" enctype="multipart/form-data" action="__URL__/{$target_url}" method="post" >
    <?php if ($target_url == 'save'): ?>
        <input type="hidden" name="id" value="{$event.id}"/>
    <?php endif ?>
    <div class="form-section" id="main-content">
        <h3 style="padding-left:15px;"> 发布公益项目  <span class="ordinary">(<span class="required">*</span>  必須填写项)</span></h3>
        <p class="after-title">{:L('以下信息将显示在公益项目页中，让大家看到你的事迹与故事。')}</p>
        <div id="editor-zone">
            <div id="editor-toolbar">
                <span>{:L('插入')}: </span>
                <a href="javascript:void(0);" id="insert-image">{:L('照片')}</a>
                <a href="javascript:void(0);" id="insert-video">{:L('视频')}</a>
                <a href="javascript:void(0);" id="insert-link">{:L('链接')}</a>
            </div>
            <p id="editor-help">{:L('为了确保资料完整请添加相关的<strong>照片</strong>和<strong>视频</strong>。')}</p>
            <div id="editor-body">
                <div id="title-part"><input type="text" name="name" id="editor-title" value="<?php if(isset($event['description'])): ?>{$event.name}<?php else: ?>在这里输入标题<?php endif; ?>"></div>
                <div id="rte-part">
                    <textarea name="description" id="editor" cols="115" rows="29">
                        <?php if(isset($event['description'])): ?>
                        {$event.description}
                        <?php else: ?>
                        项目简介： （插入相关照片,你的项目将会展示在首页中）
                        <?php endif; ?>
                    </textarea>
                </div>
                
            </div>
        </div>

        <div class="form-field">
            <span class="title"><span class="required">*</span> {:L('相关机构')}</span>
            <input type="text" name="host" class="validate[required]" value="{$event.host}"/>
        </div>
        <div class="form-field">
            <span class="title"><span class="required">*</span> {:L('执行区域')}</span>
                <select name="province" id="province" class="validate[required]"></select>省
                <select name="city" id="city"></select>市
                <select name="county" id="county"></select>区/县
                <input type="text" class="short" name="place" id="place" value="{$event.place}"/>
                <input type="hidden" name="latitude" id="latitude"/>
                <input type="hidden" name="longitude" id="longitude"/>

        </div>
        <div class="form-field" id="map-box">
            <span class="title">{:L('在地图上的位置')}</span>
            <div style="width:267px;height:163px;border:1px solid gray" id="map-locate-container"></div>
            <span>({:L('如果地图中所示位置不是您的机构位置，点击地图来标注机构位置')})</span>
            <div class="clearfix"></div>
        </div>
        <div class="form-field">
            <span class="title">{:L('开始时间')}</span>
            <input type="text" name="begin_time" id="begin_time" class="short" value="{$event.begin_time}"/>
        </div>
        <div class="form-field">
            <span class="title">{:L('结束时间')}</span>
            <input type="text" name="end_time" id="end_time" class="short" value="{$event.end_time}"/>
        </div>
        <div class="form-field check-group">
            <span class="title">{:L('项目领域')}</span><!-- 工作领域 -->
            <div class="multi-select-box">
                <input type="text" name="item_field" readonly="readonly" onselectstart="return false" value="{$event.item_field}"/>
                <div class="multi-select-dropdown">
                <?php
                    $i = 0;
                    foreach(C('ORG_FIELDS') as $org){
                    $i++;
                    ?>
                <span class="res-tag" id="focus-area">
                    <input style="display:none" id="event-field-{$i}" type="checkbox" value="{$org}" <?php if (stripos($event['item_field'], $org) !== FALSE): ?> checked="checked" <?php endif; ?>/>
                    <label for="event-field-{$i}">{$org}</label>
                </span>
                <?php } ?>
                <div class="clearfix"></div>
                </div>
            </div> <!-- end of 工作领域 -->
        </div>
        <div class="form-field check-group">
            <?php if($event_type == 'ngo'): ?>
            <span class="title">{:L('项目需求')}</span><!-- 工作领域 -->
            <?php else: ?>
            <span class="title">{:L('项目资源')}</span><!-- 工作领域 -->
            <?php endif; ?>
            <div class="multi-select-box">
                <input type="text" name="res_tags" readonly="readonly" onselectstart="return false"value="{$event.res_tags}"/>
                <div class="multi-select-dropdown">
                <?php
                    $i = 0;
                    $event_types = C('EVENT_TYPE');
                    if($event_type == 'ngo'){
                        $type_list = $event_types['requirement'];
                    }
                    else{
                        $type_list = $event_types['resource'];
                    }
                    foreach($type_list as $org){
                    $i++;
                    ?>
                <span class="res-tag" id="focus-area">
                    <input style="display:none" id="event-field-{$i}" type="checkbox" value="{$org}" <?php if (stripos($event['res_tags'], $org) !== FALSE): ?> checked="checked" <?php endif; ?>/>
                    <label for="event-field-{$i}">{$org}</label>
                </span>
                <?php } ?>
                <div class="clearfix"></div>
                </div>
            </div>
        </div>
        <?php if($event_type == 'ngo'): ?>
        <div class="form-field">
            <span class="title">{:L('需求描述')}</span>
            <textarea name="req_description" cols="35" rows="7">{$event.req_description}</textarea>
            <span>({:L('已经取得的和预期的成果')})</span>
        </div>
        <a class="hideable-section" href="javascript:void(0);" onclick="$(this).next().toggle();$(this).toggleClass('folded')">{:L('联系信息')}</a>
        <div>
            <div class="form-field">
                <span class="title">{:L('联系人')}</span>
                <input type="text" name="contact_name" value="{$event.contact_name}"/>
            </div>
            <div class="form-field">
                <span class="title">{:L('联系电话')}</span>
                <input type="text" name="contact_phone" value="{$event.contact_phone}"/>
            </div>
            <div class="form-field">
                <span class="title">{:L('电子邮箱')}</span>
                <input type="text" class="" name="contact_email" value="{$event.contact_email}"/>
            </div>
            <div class="form-field">
                <span class="title">{:L('联系QQ')}</span>
                <input type="text" class="" name="contact_qq" value="{$event.contact_qq}"/>
            </div>
            <div class="form-field">
                <span class="title">{:L('项目标签')}</span>
                <input type="text" class="" name="tags" value="{$tags}"/>
            </div>
            <div class="form-field">
                <span class="title">{:L('相关网址')}</span>
                <input type="text" class="" name="url" value="{$event.url}"/>
            </div>
        </div>
        <?php endif; ?>
        <div class="submit-buttons">
            <input id="submit-button" type="submit" value="{:L('发表项目')}"/>
            <input id="submit-button" type="reset" value="{:L('保存草稿')}"/>
        </div>
    </div> <!-- form-section -->
    </form>
</div>

<div id="upload-dialog" class="model-dialog" style="display:none;">
    <a href="javascript:void(0);" class="close-button"><img src="__APP__/Public/Img/close-button.gif" alt="关闭"/></a>
    <h4>{:L('从本地上传图片')}</h4>
    <div id="upload_button">{:L('选择本地图片')}</div>
</div>

<div id="insert-link-dialog" class="model-dialog" style="display:none;">
    <a href="javascript:void(0);" class="close-button"><img src="__APP__/Public/Img/close-button.gif" alt="关闭"/></a>
    <h4>{:L('添加链接')}</h4>
    <input type="text" id="insert-link-text"/>
    <a id="insert-link-button">{:L('添加链接')}</a>
</div>

<div id="insert-video-dialog" class="model-dialog" style="display:none;">
    <a href="javascript:void(0);" class="close-button"><img src="__APP__/Public/Img/close-button.gif" alt="关闭"/></a>
    <h4>{:L('添加在线视频')}</h4>
    <p>
        {:L('请填入网络视频地址。暂支持优酷、土豆、56网视频。')}<br/>
        <span class="error" id="video-error-message"></span>


    </p>
    <input type="text" id="insert-video-text"/>
    <a id="insert-video-button">{:L('添加视频')}</a>
</div>

<css href="__APP__/Public/Css/EventEdit.css"/>
<css href="__APP__/Public/Css/pikaday.css"/>
<link rel="stylesheet" href="__APP__/Public/Css/validationEngine.jquery.css" type="text/css"/>
<script type="text/javascript" src="__APP__/Public/Js/PCASClass.js">
</script>
<script type="text/javascript" src="__APP__/Public/Js/ajaxupload.js">
</script>
<script type="text/javascript" src="{:C('MAP_APICONNECTSTR')}">
</script>
<script src="__APP__/Public/Js/jquery.validationEngine.js" type="text/javascript" charset="utf-8"></script>
<script src="__APP__/Public/Js/jquery.rte.js" type="text/javascript" charset="utf-8"></script>
<script src="__APP__/Public/Js/jquery.validationEngine-zh_CN.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="__APP__/Public/Js/moment.min.js"></script>
<script type="text/javascript" src="__APP__/Public/Js/pikaday.min.js"></script>
<script type="text/javascript" src="__APP__/Public/Js/user-event-edit.js"></script>

<script langage="text/javascript">

$('#editor').rte();
$(function(){
    var iframe = document.getElementById('editor-rte');
    fixIframeCaret(iframe);
    $('iframe#editor-rte').contents().find('body').css('font-size','12px');
    $('iframe#editor-rte').contents().find('body').css('color','#b5b5b5');
    $('iframe#editor-rte').contents().find('body').focus(function(){
        if(!touched_editor_content){
            var docbody = $('iframe#editor-rte').contents().find('body');
            docbody.css('color','#000');
            touched_editor_content = docbody.html();
            docbody.html('');
        }
    });

    $('iframe#editor-rte').contents().find('body').blur(function(){
        var docbody = $('iframe#editor-rte').contents().find('body');
        if(docbody.html() == ''){
            docbody.html(touched_editor_content);
            docbody.css('color','#b5b5b5');
            touched_editor_content = false;
        }
    });
});

var touched_editor_title = false;
var touched_editor_content = false;
$('#editor-title').focus(function(){
    if(!touched_editor_title){
        touched_editor_title = $('#editor-title').val();
        $('#editor-title').val('');
    }
});

$('#editor-title').blur(function(){
    if($('#editor-title').val() == ''){
        $('#editor-title').val(touched_editor_title);
        touched_editor_title = false;
    }
});


$('#insert-video-button').click(function(){
    var youku_url = /youku\.com.+id_(.+)\.html/;
    var tudou_url = /tudou\.com\/programs\/view\/(.+)\//;
    var video_url = $('#insert-video-text').val();
    var url_56 = /56\.com.+v_(.+)\.html/;
    var result = "";
    
    if(m=video_url.match(youku_url)){
        result = 'http://player.youku.com/player.php/sid/'+m[1]+'/v.swf';
    }
    else if(m=video_url.match(tudou_url)){
        result = 'http://www.tudou.com/v/'+m[1]+'/v.swf';
    }
    else if(m=video_url.match(url_56)){
        result = 'http://player.56.com/v_'+m[1]+'.swf';
    }

    if(result != ''){
        var html = '<embed src="'+result+'" quality="high" width="480" height="400" align="middle" allowScriptAccess="sameDomain" allowFullscreen="true" type="application/x-shockwave-flash"></embed>';
        insertIt('editor-rte',html);
        $('#insert-link-dialog').trigger('close');
    }
    else{
        $('#video-error-message').text('无法解析视频地址');
    }
});

$('#insert-link-button').click(function(){
    var link = $('#insert-link-text').val();
    insertIt('editor-rte','<a href="'+link+'">'+link+'</a>');
    $('#insert-link-dialog').trigger('close');
});

//rte-section
$('#insert-image').click(function(){
    $('#upload-dialog').lightbox_me({centered: true});
    new AjaxUpload('upload_button', {
        action: app_path+'/Event/upload_image',
        onComplete: function(file, response) {
            console.log(response);
            $('#upload-dialog').trigger('close');
            insertIt('editor-rte','<img src="'+app_path+'/Public/Uploadedthumb/thumbl_'+response+'"/>');
            //var doc = $('iframe#editor-rte').contents()[0];
            //document.getElementById('editor-rte').contentWindow.focus();
            //doc.execCommand('InsertImage', false, app_path+'/Public/Uploadedthumb/thumbl_'+response);
        }
    });
});
$('#insert-link').click(function(){
    $('#insert-link-dialog').lightbox_me({centered: true});
    $('#insert-link-text').val('http://');
});
$('#insert-video').click(function(){
    $('#insert-video-dialog').lightbox_me({centered: true});
    $('#insert-video-text').val('');
    $('#video-error-message').text('');
});

$('#upload-dialog .close-button').click(function(){
    $('#upload-dialog').trigger('close');
});
$('#insert-link-dialog .close-button').click(function(){
    $('#insert-link-dialog').trigger('close');
});
$('#insert-video-dialog .close-button').click(function(){
    $('#insert-video-dialog').trigger('close');
});

pikaday_i18n = {
    months        : ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','二月'],
    weekdays      : ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],
    weekdaysShort : ['日','一','二','三','四','五','六']
};

var begin_picker = new Pikaday({
        field: document.getElementById('begin_time'),
        format: 'YYYY-MM-DD',
        i18n: pikaday_i18n
    });
var end_picker = new Pikaday({
        field: document.getElementById('end_time'),
        format: 'YYYY-MM-DD',
        i18n: pikaday_i18n
    });

function insertIt(editor,html) {
    var win = document.getElementById(editor).contentWindow, doc = win.document;
    var sel, range;
    if (win.getSelection) {
        // IE9 and non-IE
        sel = win.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();

            // Range.createContextualFragment() would be useful here but is
            // non-standard and not supported in all browsers (IE9, for one)
            var el = doc.createElement("div");
            el.innerHTML = html;
            var frag = doc.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);

            // Preserve the selection
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    } else if (doc.selection && doc.selection.type != "Control") {
        // IE < 9
        win.focus();
        IEselectedRange.pasteHTML(html);
    }
}

var IEselectedRange = null;

function fixIframeCaret(iframe) {
    if (iframe.attachEvent) {
        iframe.attachEvent("onbeforedeactivate", function() {
            var sel = iframe.contentWindow.document.selection;
            IEselectedRange = sel.createRange();
        });
    }
}

</script>

<?php if($target_url == 'save'): ?>
<script type="text/javascript">
//disable default status for rte
touched_editor_title = true;
touched_editor_content = true;
$('iframe#editor-rte').contents().find('body').css('color','#000');

//handle province selector
$('#province option[value="{$event.province}"]').attr('selected', true);
$('#province').change();
$('#city option[value="{$event.city}"]').attr('selected', true);
$('#city').change();
$('#county option[value="{$event.county}"]').attr('selected', true);

//handle custum checkbox initial status
$('.res-tag input[checked="checked"]').next().addClass('selected');

//place a mark on the map and set lng/lat as well
addPointMarker(new BMap.Point({$event.longitude},{$event.latitude}));
</script>
<?php endif; ?>

{:W('Footer')}
